<!-- public/mybookings.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Bookings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <!-- Navbar (reduce copy paste errors: keep this same in all pages) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="rooms.html">Hotel Management</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="register.html">Register</a></li>
          <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="rooms.html">Rooms</a></li>
          <li class="nav-item"><a class="nav-link active" href="mybookings.html">My Bookings</a></li>
          <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2 class="mb-4">My Bookings</h2>

    <div id="bookingsContainer" class="row"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Ensure logged-in
    const customerId = localStorage.getItem('customerId');
    if (!customerId) {
      alert('Please login first');
      window.location.href = '/login.html';
      throw new Error('Not logged in');
    }

    async function loadBookings() {
      try {
        let res = await fetch(`/api/bookings/${customerId}`);
        if (!res.ok) {
          // fallback: try query param
          res = await fetch(`/api/bookings?customerId=${customerId}`);
        }
        const bookings = await res.json();

        const container = document.getElementById('bookingsContainer');
        container.innerHTML = '';

        if (!Array.isArray(bookings) || bookings.length === 0) {
          container.innerHTML = '<p class="text-muted">You have no bookings yet.</p>';
          return;
        }

        bookings.forEach(b => {
          // Use canonical model fields: checkInDate / checkOutDate
          const from = new Date(b.checkInDate || b.dateFrom || b.checkIn || b.checkin).toLocaleDateString();
          const to = new Date(b.checkOutDate || b.dateTo || b.checkOut || b.checkout).toLocaleDateString();

          const room = b.room || {};
          const roomType = room.roomType || room.type || 'Room';
          const roomNumber = room.roomNumber || room.number || '—';
          const rate = room.pricePerNight || room.rate || room.price || '—';
          const total = b.totalAmount || b.totalPrice || '—';
          const status = b.status || 'Booked';

          const col = document.createElement('div');
          col.className = 'col-md-6 mb-3';
          col.innerHTML = `
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">${roomType} — #${roomNumber}</h5>
                <p class="card-text">From: <strong>${from}</strong></p>
                <p class="card-text">To: <strong>${to}</strong></p>
                <p class="card-text">Rate: ₹${rate}</p>
                <p class="card-text">Total: ₹${total}</p>
                <p class="card-text">Status: ${status}</p>
                <a href="/invoice.html?bookingId=${b._id || b.id}" class="btn btn-sm btn-outline-primary">View Invoice</a>
              </div>
            </div>
          `;
          container.appendChild(col);
        });
      } catch (err) {
        console.error('Error loading bookings', err);
        document.getElementById('bookingsContainer').innerHTML = '<p class="text-danger">Could not load bookings.</p>';
      }
    }

    loadBookings();
  </script>
</body>
</html>
